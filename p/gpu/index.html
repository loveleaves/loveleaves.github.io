<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="主要介绍GPU的架构及其C++使用">
<title>【GPU】 GPU架构及使用介绍</title>

<link rel='canonical' href='https://loveleaves.github.io/p/gpu/'>

<link rel="stylesheet" href="/scss/style.min.4f655c339a336b15a106fd248f9170c8064dfc6f1990313665402f49a0c0831e.css"><meta property='og:title' content="【GPU】 GPU架构及使用介绍">
<meta property='og:description' content="主要介绍GPU的架构及其C++使用">
<meta property='og:url' content='https://loveleaves.github.io/p/gpu/'>
<meta property='og:site_name' content='安哲睿'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-01-03T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-03-05T20:45:08&#43;08:00'/>
<meta name="twitter:title" content="【GPU】 GPU架构及使用介绍">
<meta name="twitter:description" content="主要介绍GPU的架构及其C++使用">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_b4d2f495c38e1067.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">😁</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">安哲睿</a></h1>
            <h2 class="site-description">世上无难事，只怕有心人</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/loveleaves'
                        target="_blank"
                        title="Github"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/loveleaves'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://loveleaves.github.io/en/" >English</option>
                                
                                    <option value="https://loveleaves.github.io/" selected>简体中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#介绍">介绍</a>
      <ol>
        <li><a href="#cuda驱动driverapi">CUDA驱动(driver)API</a></li>
        <li><a href="#cuda运行时runtimeapi">CUDA运行时(runtime)API</a></li>
      </ol>
    </li>
    <li><a href="#references">References</a></li>
    <li><a href="#cuda框架">CUDA框架</a>
      <ol>
        <li><a href="#基础编程框架">基础编程框架</a></li>
        <li><a href="#nvcc编译工作原理">nvcc编译工作原理</a></li>
        <li><a href="#gpu设备设置">GPU设备设置</a></li>
        <li><a href="#内存管理">内存管理</a></li>
        <li><a href="#数据同步synchronize">数据同步Synchronize</a></li>
        <li><a href="#核函数kernel-function">核函数（Kernel function）</a></li>
        <li><a href="#自定义设备函数">自定义设备函数</a></li>
        <li><a href="#线程模型">线程模型</a></li>
      </ol>
    </li>
    <li><a href="#cuda错误检查">CUDA错误检查</a>
      <ol>
        <li><a href="#运行时错误检测">运行时错误检测</a></li>
        <li><a href="#功能正确性检查">功能正确性检查</a></li>
      </ol>
    </li>
    <li><a href="#获得gpu加速的关键">获得GPU加速的关键</a>
      <ol>
        <li><a href="#cuda事件计时">CUDA事件计时</a></li>
        <li><a href="#程序性能分析">程序性能分析</a></li>
        <li><a href="#影响gpu加速的关键因素">影响GPU加速的关键因素</a></li>
        <li><a href="#cuda中的数学函数库">CUDA中的数学函数库</a></li>
      </ol>
    </li>
    <li><a href="#内存组织">内存组织</a>
      <ol>
        <li><a href="#全局内存global-memory">全局内存（global memory）</a></li>
        <li><a href="#常量内存constant-memory">常量内存（constant memory）</a></li>
        <li><a href="#纹理内存texture-memory和表面内存surface-memory">纹理内存（texture memory）和表面内存（surface memory）</a></li>
        <li><a href="#寄存器register和-局部内存local-memory">寄存器（register）和 局部内存（local memory）</a></li>
        <li><a href="#共享内存shared-memory">共享内存（shared memory）</a></li>
        <li><a href="#l1-和-l2-缓存">L1 和 L2 缓存</a></li>
        <li><a href="#sm及其占有率">SM及其占有率</a></li>
      </ol>
    </li>
    <li><a href="#高效正确地并发并行">高效正确地并发并行</a>
      <ol>
        <li><a href="#原子函数atomic-function">原子函数（atomic function）</a></li>
        <li><a href="#线程束warp基本函数">线程束（warp）基本函数</a></li>
        <li><a href="#协作组cooperativegroups">协作组（cooperativegroups）</a></li>
      </ol>
    </li>
    <li><a href="#cuda流cuda-stream">CUDA流（CUDA stream）</a>
      <ol>
        <li><a href="#cuda流介绍">CUDA流介绍</a></li>
        <li><a href="#默认流default-stream-为空流null-stream">默认流（default stream）/ 为空流（null stream）</a></li>
        <li><a href="#非默认流非空流">非默认流/非空流</a></li>
      </ol>
    </li>
    <li><a href="#统一内存unifiedmemory编程">统一内存（unifiedmemory）编程</a>
      <ol>
        <li><a href="#介绍-1">介绍</a></li>
        <li><a href="#基本使用">基本使用</a></li>
      </ol>
    </li>
    <li><a href="#多gpu编程">多GPU编程</a></li>
    <li><a href="#cuda标准库">CUDA标准库</a>
      <ol>
        <li><a href="#thrust">Thrust</a></li>
        <li><a href="#cublasbasic-linear-algebra-subprograms">cuBLAS（basic linear algebra subprograms）</a></li>
        <li><a href="#cufft">cuFFT</a></li>
        <li><a href="#cusparse">cuSPARSE</a></li>
        <li><a href="#cusolver">cuSolver</a></li>
        <li><a href="#curand">cuRAND</a></li>
        <li><a href="#cudnn">cuDNN</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/quantization/" >
                Quantization
            </a>
        
            <a href="/categories/hpc/" >
                HPC
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/gpu/">【GPU】 GPU架构及使用介绍</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            主要介绍GPU的架构及其C&#43;&#43;使用
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 03, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 19 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="介绍">介绍
</h2><p>CUDA（Compute Unified Device Architecture，统⼀计算架构）是由 NVIDIA 开发的并行计算平台和编程模型，旨在利用 NVIDIA GPU（图形处理单元）强大的并行计算能力来加速计算密集型任务。CUDA 提供了一种编程接口，让程序员能够直接访问 GPU 上的计算资源。通过并行化计算任务，可以显著提升执行效率。GPU 相较于 CPU，在处理大量并行任务时具有显著的优势，通常拥有成百上千的处理核心（CUDA 核心），能够同时执行大量的操作。</p>
<ul>
<li>核心指标：核心数、GPU显存容量、GPU计算峰值、显存带宽</li>
<li>GPU不能单独计算，CPU+GPU组成异构计算架构：CPU起到控制作用，一般称为主机（Host）；GPU可以看作CPU的协处理器，一般称为设备（Device）；主机和设备之间内存访问一般通过PCIe总线链接。</li>
<li>CUDA 提供两层API接口：CUDA驱动(driver)API和CUDA运行时(runtime)API</li>
</ul>
<h3 id="cuda驱动driverapi">CUDA驱动(driver)API
</h3><ul>
<li>cuda driver使用方式：libcuda.so和cuda.h，<a class="link" href="https://docs.nvidia.com/cuda/cuda-driver-api/index.html"  target="_blank" rel="noopener"
    >cuda-driver-api</a></li>
<li>context管理机制：方便管理device
<ul>
<li>
<ol>
<li>手动管理的context,cuCtxCreate(手动管理，以堆栈方式push/pop)</li>
</ol>
</li>
<li>
<ol start="2">
<li>自动管理的context,cuDevicePrimaryCtxRetain(自动管理，runtime api以此为基础)</li>
</ol>
</li>
</ul>
</li>
<li>首先需要调用culnit初始化驱动API</li>
</ul>
<h3 id="cuda运行时runtimeapi">CUDA运行时(runtime)API
</h3><ul>
<li>cuda runtime使用方式：libcudart.so和cuda_runtime.h。<a class="link" href="https://docs.nvidia.com/cuda/cuda-runtime-api/index.html"  target="_blank" rel="noopener"
    >runtime API</a>随cuda toolkit发布</li>
<li>主要内容：核函数的使用、线程束布局、内存模型、流的使用</li>
<li>主要实现：归约求和、仿射变换、矩阵乘法、模型后处理</li>
</ul>
<h2 id="references">References
</h2><ul>
<li><a class="link" href="https://github.com/SeventhBlue/cudaLearningMaterials_2/blob/master/CUDA%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1-GPU%E7%BC%96%E7%A8%8B%E6%8C%87%E5%8D%97-%E9%AB%98%E6%B8%85%E6%89%AB%E6%8F%8F-%E4%B8%AD%E8%8B%B1%E6%96%87/CUDA%20Programming%20A%20Developer%27s%20Guide%20to%20Parallel%20Computing%20with%20GPUs.pdf"  target="_blank" rel="noopener"
    >《CUDA 并行程序设计-GPU 编程指南》</a> 第5、6、9章</li>
<li><a class="link" href="https://github.com/loveleaves/ML_CPP/tree/main/ParallelFramework/CUDA"  target="_blank" rel="noopener"
    >https://github.com/loveleaves/ML_CPP/tree/main/ParallelFramework/CUDA</a></li>
<li><a class="link" href="https://docs.nvidia.com/cuda/index.html"  target="_blank" rel="noopener"
    >cuda docs</a>、<a class="link" href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html"  target="_blank" rel="noopener"
    >programming-guide</a>、<a class="link" href="https://docs.nvidia.com/cuda/cuda-c-best-practices-guide/index.html"  target="_blank" rel="noopener"
    >best-practices-guide</a></li>
<li><a class="link" href="https://cis5650-fall-2024.github.io/"  target="_blank" rel="noopener"
    >CIS 5650-GPU Programming and Architecture</a></li>
<li><a class="link" href="https://staskaer.github.io/2022/09/05/CUDA%E9%AB%98%E6%80%A7%E8%83%BD%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97-2/"  target="_blank" rel="noopener"
    >CUDA笔记</a></li>
<li><a class="link" href="https://github.com/NVIDIA/CUDALibrarySamples"  target="_blank" rel="noopener"
    >CUDALibrarySamples</a></li>
</ul>
<h2 id="cuda框架">CUDA框架
</h2><h3 id="基础编程框架">基础编程框架
</h3><p>单文件example.cu编程框架</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">header</span> <span class="n">inclusion</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">or</span> <span class="n">macro</span> <span class="n">definition</span>
</span></span><span class="line"><span class="cl"><span class="n">declarations</span> <span class="n">of</span> <span class="n">C</span><span class="o">++</span> <span class="n">functions</span> <span class="n">and</span> <span class="n">CUDA</span> <span class="n">kernels</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocate</span> <span class="n">host</span> <span class="n">and</span> <span class="n">device</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl">    <span class="n">initialize</span> <span class="n">data</span> <span class="n">in</span> <span class="n">host</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl">    <span class="n">transfer</span> <span class="n">data</span> <span class="n">from</span> <span class="n">host</span> <span class="n">to</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">    <span class="n">launch</span> <span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="n">kernel</span> <span class="n">to</span> <span class="k">do</span> <span class="n">calculations</span> <span class="n">in</span> <span class="n">the</span> <span class="n">device</span>
</span></span><span class="line"><span class="cl">    <span class="n">transfer</span> <span class="n">data</span> <span class="n">from</span> <span class="n">device</span> <span class="n">to</span> <span class="n">host</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span> <span class="n">host</span> <span class="n">and</span> <span class="n">device</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">definitions</span> <span class="n">of</span> <span class="n">C</span><span class="o">++</span> <span class="n">functions</span> <span class="n">and</span> <span class="n">CUDA</span> <span class="n">kernels</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译指令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">nvcc -arch=sm_XY -code=compute_XY -o example example.cu
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nvcc编译工作原理">nvcc编译工作原理
</h3><p><img src="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/_images/cuda-compilation-from-cu-to-executable.png"
	
	
	
	loading="lazy"
	
		alt="CUDA Compilation Trajectory"
	
	
></p>
<ul>
<li>host code（standard C/C++ compiler）、device code（compiled into PTX/cubin）</li>
<li>CUDA程序兼容性考虑：在将源代码编译为 PTX 代码时，需要用选项-arch=compute_XY指定一个虚拟架构的计算能力，用以确定代码中能够使用的CUDA功能。在将PTX代码编译为cubin代码时，需要用选项-code=sm_ZW指定一个真实架构的计算能力，用以确定可执行文件能够使用的GPU。</li>
<li><a class="link" href="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html"  target="_blank" rel="noopener"
    >https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html</a></li>
<li><a class="link" href="https://www.kapilsharma.dev/posts/deep-dive-into-triton-internals/"  target="_blank" rel="noopener"
    >Deep Dive into Triton Internals</a></li>
</ul>
<h3 id="gpu设备设置">GPU设备设置
</h3><ul>
<li>1、获取GPU设备数量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">int iDeviceCount = 0;
</span></span><span class="line"><span class="cl">cudaGetDeviceCount(&amp;iDeviceCount);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>2、设置GPU执行时使用的设备</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">int iDev = 0;
</span></span><span class="line"><span class="cl">cudaSetDevice(iDev)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="内存管理">内存管理
</h3><p>主设内存管理
<strong>Note</strong>：GPU内存管理runtime接口传入的是<strong>双重指针</strong>。</p>
<ul>
<li>内存分配：malloc、cudaMalloc</li>
<li>数据传递：memcpy、cudaMemcpy</li>
<li>内存初始化：memset、cudaMemset</li>
<li>内存释放：free、cudaFree</li>
</ul>
<p>主设内存传递</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cudaError_t cudaMemcpy(dst, src, count, kind);
</span></span></code></pre></td></tr></table>
</div>
</div><p>枚举类型kind可取值：</p>
<ul>
<li>cudaMemcpyHostToHost，表示从主机复制到主机。</li>
<li>cudaMemcpyHostToDevice，表示从主机复制到设备。</li>
<li>cudaMemcpyDeviceToHost，表示从设备复制到主机。</li>
<li>cudaMemcpyDeviceToDevice，表示从设备复制到设备。</li>
<li>cudaMemcpyDefault，表示根据指针dst和src所指地址自动判断数据传输的方向。这要求系统具有统一虚拟寻址（unifiedvirtualaddressing）的功能（要求64位的主机）。</li>
</ul>
<h3 id="数据同步synchronize">数据同步Synchronize
</h3><ul>
<li>调用输出函数时，输出流是先存放在缓冲区的，而缓冲区不会自动刷新。只有程序遇到某种同步操作时缓冲区才会刷新。所以当要打印某个数据时，要先使用函数cudaDeviceSynchronize显式地同步主机与设备，促使缓冲区刷新。</li>
</ul>
<h3 id="核函数kernel-function">核函数（Kernel function）
</h3><ul>
<li>1、核函数<strong>在GPU上</strong>进行<strong>并行执行</strong></li>
<li>2、注意：
<ul>
<li>（1）限定词__global__ 修饰（可在void前后）</li>
<li>（2）返回值必须是void</li>
<li>（3）对于N是非blockSize整数倍时，必要时添加if，即使导致条件分支</li>
</ul>
</li>
</ul>
<p><strong>注意事项：</strong></p>
<ul>
<li>1、核函数只能访问GPU内存</li>
<li>2、核函数不能使用变长参数</li>
<li>3、核函数不能使用静态变量</li>
<li>4、核函数不能使用函数指针</li>
<li>5、核函数具有异步性</li>
<li>6、其他：核函数不支持C++的iostream</li>
</ul>
<h3 id="自定义设备函数">自定义设备函数
</h3><ul>
<li>用__global__修饰的函数称为核函数，一般由主机调用，在设备中执行。如果使用动态并行，则也可以在核函数中调用自己或其他核函数。</li>
<li>用__device__修饰的函数叫称为设备函数，只能被核函数或其他设备函数调用，在设备中执行。</li>
<li>用__host__修饰的函数就是主机端的普通C++函数，在主机中被调用，在主机中执行。对于主机端的函数，该修饰符可省略。之所以提供这样一个修饰符，是因为有时可以用__host__和__device__同时修饰一个函数，使得该函数既是一个C++中的普通函数，又是一个设备函数。这样做可以减少冗余代码。编译器将针对主机和设备分别编译该函数。</li>
<li>不能同时用__device__和__global__修饰一个函数，即不能将一个函数同时定义为设备函数和核函数。</li>
<li>也不能同时用__host__和__global__修饰一个函数，即不能将一个函数同时定义为主机函数和核函数。</li>
</ul>
<h3 id="线程模型">线程模型
</h3><ul>
<li>线程的组织结构是由执行配置（executionconfiguration）&laquo;&lt;grid_size,block_size&raquo;&gt;决定的。这里的grid_size（网格大小）和block_size（线程块大小），对应核函数内部的内建变量 gridDim、blockDim、blockIdx、threadIdx</li>
<li>注意GPU系列对应框架最大允许的线程块大小，如1024</li>
<li>线程束：线程调度、管理</li>
</ul>
<h2 id="cuda错误检查">CUDA错误检查
</h2><h3 id="运行时错误检测">运行时错误检测
</h3><p>所有CUDA运行时API函数都是以cuda为前缀的，而且都有一个类型为cudaError_t的返回值，代表了一种错误信息。只有返回值为cudaSuccess时才代表成功地调用了API函数。</p>
<h3 id="功能正确性检查">功能正确性检查
</h3><ul>
<li>内存检查、越界访问、异常检查等</li>
<li><a class="link" href="https://loveleaves.github.io/p/tool/"  target="_blank" rel="noopener"
    >checktool</a></li>
</ul>
<h2 id="获得gpu加速的关键">获得GPU加速的关键
</h2><h3 id="cuda事件计时">CUDA事件计时
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cudaEvent_t start, stop;
</span></span><span class="line"><span class="cl">CHECK(cudaEventCreate(&amp;start));
</span></span><span class="line"><span class="cl">CHECK(cudaEventCreate(&amp;stop));
</span></span><span class="line"><span class="cl">CHECK(cudaEventRecord(start));
</span></span><span class="line"><span class="cl">cudaEventQuery(start); // 此处不能用 CHECK 宏函数，对处于TCC 驱动模式的 GPU 来说可以省略，但对处于 WDDM 驱动模式的GPU来说必须保留。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">需要计时的代码块
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CHECK(cudaEventRecord(stop));
</span></span><span class="line"><span class="cl">CHECK(cudaEventSynchronize(stop));
</span></span><span class="line"><span class="cl">float elapsed_time;
</span></span><span class="line"><span class="cl">CHECK(cudaEventElapsedTime(&amp;elapsed_time, start, stop));
</span></span><span class="line"><span class="cl">printf(&#34;Time = %g ms.\n&#34;, elapsed_time);
</span></span><span class="line"><span class="cl">CHECK(cudaEventDestroy(start));
</span></span><span class="line"><span class="cl">CHECK(cudaEventDestroy(stop));
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="程序性能分析">程序性能分析
</h3><p>Nsight Compute，详见<a class="link" href="https://loveleaves.github.io/p/tool/"  target="_blank" rel="noopener"
    >tools</a></p>
<h3 id="影响gpu加速的关键因素">影响GPU加速的关键因素
</h3><ul>
<li>数据传输的比例：主设数据传输</li>
<li>算术强度（arithmeticintensity）：计算相比于数据传输耗时的占比</li>
<li>并行规模：数据规模要尽量匹配SM等计算资源</li>
</ul>
<p>因此, 在编写与优化CUDA程序时，一定要想方设法（主要是指仔细设计算法）做到以下几点</p>
<ul>
<li>减少主机与设备之间的数据传输。</li>
<li>提高核函数的算术强度。</li>
<li>增大核函数的并行规模。</li>
</ul>
<h3 id="cuda中的数学函数库">CUDA中的数学函数库
</h3><blockquote>
<p><a class="link" href="https://docs.nvidia.com/cuda/cuda-math-api/"  target="_blank" rel="noopener"
    >https://docs.nvidia.com/cuda/cuda-math-api/</a></p></blockquote>
<ol>
<li>单精度浮点数内建函数和数学函数（singleprecisionintrinsics and math functions）。使用该类函数时不需要包含任何额外的头文件。</li>
<li>双精度浮点数内建函数和数学函数（doubleprecisionintrinsicsandmathfunctions）。使用该类函数时不需要包含任何额外的头文件。</li>
<li>半精度浮点数内建函数和数学函数（halfprecisionintrinsicsandmathfunctions）。使用该类函数时需要包含头文件&lt;cuda_fp16.h&gt;。</li>
<li>整数类型的内建函数（integerintrinsics）。使用该类函数时不需要包含任何额外的头文件。</li>
<li>类型转换内建函数（typecasting intrinsics）。使用该类函数时不需要包含任何额外的头文件。</li>
<li>单指令-多数据内建函数（SIMDintrinsics）。使用该类函数时不需要包含任何额外的头文件。</li>
</ol>
<h2 id="内存组织">内存组织
</h2><p>分层思想，平衡成本和效率（在编码中体现为高内聚、低耦合）
<img src="/imgs/gpu_1.png"
	
	
	
	loading="lazy"
	
	
>
<img src="/imgs/gpu_2.png"
	
	
	
	loading="lazy"
	
	
></p>
<ul>
<li><a class="link" href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#device-variable-specifier"  target="_blank" rel="noopener"
    >https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#device-variable-specifier</a></li>
<li>不同硬件架构的内存编排不一定相同</li>
</ul>
<h3 id="全局内存global-memory">全局内存（global memory）
</h3><ul>
<li>核函数中的所有线程都能够访问其中的数据，容量是所有设备内存中最大的。基本上就是显存容量。</li>
<li>主要为核函数提供数据，并在主机与设备及设备与设备之间传递数据。</li>
<li>host端访问数据：使用runtime接口<code>cudaGetSymbolAddress() / cudaGetSymbolSize() / cudaMemcpyToSymbol() / cudaMemcpyFromSymbol()</code></li>
<li>同步函数<code>__syncthreads()</code>：只是针对同一个线程块中的线程的，不同线程块中线程的执行次序依然是不确定的（不同线程块数据要保证不依赖）。</li>
<li>在CUDA中还有一种内部构造对用户不透明的（nottransparent）全局内存，称为CUDAArray。CUDAArray使用英伟达公司不对用户公开的数据排列方式，专为纹理拾取服务。</li>
</ul>
<p><strong>动态全局内存</strong></p>
<ul>
<li>生命周期（lifetime）不是由核函数决定的，而是由主机端决定的（cudaMalloc、cudaFree）</li>
</ul>
<p><strong>静态全局内存</strong></p>
<ul>
<li><strong>静态全局内存变量</strong>由以下方式在任何函数外部定义：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">__device__ T x; // 单个变量
</span></span><span class="line"><span class="cl">__device__ T y[N]; // 固定长度的数组
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在核函数中，可直接对静态全局内存变量进行访问，并不需要将它们以参数的形式传给核函数。</li>
</ul>
<h3 id="常量内存constant-memory">常量内存（constant memory）
</h3><ul>
<li>有常量缓存的全局内存，一共仅有64KB，位于常量内存空间，核函数外部用<code>__constant__</code>定义。</li>
<li>它的可见范围和生命周期与全局内存一样，host端访问数据与全局内存一样。
由于有缓存，常量内存的访问速度比全局内存高，但得到高访问速度的前提是一个线程束中的线程（一个线程块中相邻的32个线程）要读取相同的常量内存数据。</li>
</ul>
<h3 id="纹理内存texture-memory和表面内存surface-memory">纹理内存（texture memory）和表面内存（surface memory）
</h3><ul>
<li>类似于常量内存，也是一种具有缓存的全局内存，有相同的可见范围和生命周期，而且一般仅可读（表面内存也可写）。不同的是，纹理内存和表面内存容量更大，而且使用方式和常量内存也不一样。</li>
<li>对于计算能力5.0以上的GPU来说，将某些只读全局内存数据用<code>__ldg()</code>函数通过只读数据缓存（read-onlydatacache）读取，既可达到使用纹理内存的加速效果，又可使代码简洁。对帕斯卡架构和更高的架构来说，全局内存的读取在默认情况下就利用了__ldg()函数，所以不需要明显地使用它。</li>
</ul>
<h3 id="寄存器register和-局部内存local-memory">寄存器（register）和 局部内存（local memory）
</h3><ul>
<li>存储函数入参、内建变量和临时变量等，32位。</li>
<li>计算能力5.0~9.0的GPU，每个中都是64K的寄存器数量，Fermi架构只有32K；</li>
<li>考虑：每个线程块使用的最大数量、每个线程的最大寄存器数量</li>
<li>局部内存是全局内存的一部分，寄存器溢出是保存在局部内存中。</li>
</ul>
<h3 id="共享内存shared-memory">共享内存（shared memory）
</h3><ul>
<li>和寄存器类似，存在于芯片上，具有仅次于寄存器的读写速度，<code>extern __shared__ float shared[]</code>定义，数组大小在运行时确定,或<code>__shared__ float shared[100]</code>。</li>
<li>共享内存对整个线程块可见，其生命周期也与整个线程块一致。</li>
<li>一个线程块中的所有线程都可以访问该线程块的共享内存变量副本，但是不能访问其他线程块的共享内存变量副本。</li>
<li>注意避免n路bank冲突（n很大场景，类似TLB组相联）：共享内存在物理上被分为32个（刚好等于一个线程束中的线程数目，即内建变量warpSize的值）同样宽度的、能被同时访问的内存bank。在所有其他架构中，每个bank的宽度为4字节。当同一线程束内的多个线程不同时访问同一个bank中不同层的数据，该线程束对共享内存的访问就只需要一次内存事务（memory transaction）,就会发生bank冲突。</li>
</ul>
<h3 id="l1-和-l2-缓存">L1 和 L2 缓存
</h3><ul>
<li>从费米架构开始，有了SM层次的L1缓存和设备（一个设备有多个SM）层次的L2缓存</li>
</ul>
<h3 id="sm及其占有率">SM及其占有率
</h3><p><strong>SM（Streaming MultiProcessor）构成</strong></p>
<p>一个GPU是由多个SM构成的。一个SM包含如下资源（不同架构不一定相同）：</p>
<ul>
<li>一定数量的寄存器。</li>
<li>一定数量的共享内存。</li>
<li>常量内存的缓存。</li>
<li>纹理和表面内存的缓存。</li>
<li>L1缓存。</li>
<li>两个（计算能力6.0）或4个（其他计算能力）线程束调度器（warpscheduler），用于在不同线程的上下文之间迅速地切换，以及为准备就绪的线程束发出执行指令。</li>
<li>执行核心，包括：
<ul>
<li>若干整型数运算的核心（INT32）。</li>
<li>若干单精度浮点数运算的核心（FP32）。</li>
<li>若干双精度浮点数运算的核心（FP64）。</li>
<li>若干单精度浮点数超越函数（transcendentalfunctions）的特殊函数单元（Special Function Units，SFUs）。</li>
<li>若干混合精度的张量核心（tensorcores，由伏特架构引入，适用于机器学习中的低精度矩阵计算）。</li>
</ul>
</li>
</ul>
<p><strong>SM管理</strong></p>
<ul>
<li>GPU中每个SM都可以支持数百个线程<strong>并发</strong>执行</li>
<li>以线程块block为单位，向SM分配线程块，多个线程块可被同时分配到一个可用的SM上</li>
<li>当一个线程块被分配好后，就不可以在分配到其他上了</li>
</ul>
<p><strong>线程束（warp）</strong></p>
<ul>
<li>CUDA 采用单指令多线程架构管理执行线程，每32个为一组，构成一个线程束。同一个线程块中相邻的 32个线程构成一个线程束</li>
<li>每个线程束中只能包含同一线程块中的线程</li>
<li>线程束是GPU硬件上真正的做到了<strong>并行</strong></li>
</ul>
<p>** SM 的占有率**</p>
<ul>
<li>一般来说，要尽量让SM的占有率不小于某个值，比如%，才有可能获得较高的性能。</li>
<li>SM的理论占有率（theoreticaloccupancy）的两个指标:
<ul>
<li>一个SM中最多能拥有的<strong>线程块个数</strong></li>
<li>一个SM中最多能拥有的<strong>线程个数</strong></li>
</ul>
</li>
<li>根据寄存器、共享内存等具体架构具体分析</li>
</ul>
<h2 id="高效正确地并发并行">高效正确地并发并行
</h2><h3 id="原子函数atomic-function">原子函数（atomic function）
</h3><p>cuda提供原子函数来进行控制数据一致性读写。其中<code>atomicCAS</code>函数是比较特殊的，所有其他原子函数都可以用它实现（指定架构不支持时，但性能可能较差）。</p>
<ul>
<li>Atomic APIs with <code>_system</code> suffix (example: <code>atomicAdd_system</code>) are atomic at scope <code>cuda::thread_scope_system</code> if they meet particular <a class="link" href="https://nvidia.github.io/cccl/libcudacxx/extended_api/memory_model.html"  target="_blank" rel="noopener"
    >conditions</a>. compute capability must greater than 7.2.</li>
<li>Atomic APIs without a suffix (example: <code>atomicAdd</code>) are atomic at scope <code>cuda::thread_scope_device</code>.</li>
<li>Atomic APIs with <code>_block</code> suffix (example: <code>atomicAdd_block</code>) are atomic at scope <code>cuda::thread_scope_block</code>.</li>
</ul>
<p><img src="/imgs/gpu_3.png"
	
	
	
	loading="lazy"
	
		alt="atomic"
	
	
></p>
<h3 id="线程束warp基本函数">线程束（warp）基本函数
</h3><ul>
<li>一个SM以32个线程为单位产生、管理、调度、执行线程。这样的32 个线程称为一个<strong>线程束</strong>。</li>
<li>SM执行属于单指令-多线程（single instruction, multiple thread，<strong>SIMT</strong>）的执行模式：在同一时刻，一个线程束中的线程只能执行一个共同的指令或者闲置。</li>
<li>在伏特架构之前，一个线程束中的线程拥有同一个程序计数器（programcounter），但各自有不同的寄存器状态（registerstate），从而可以根据程序的逻辑判断选择不同的分支。因此当<strong>同一个线程束</strong>（不同的不会）中的线程顺序地执行判断语句中的不同分支时，会发生<strong>分支发散</strong>（branch divergence）。</li>
<li>从<strong>伏特架构</strong>开始，引入了独立线程调度（independentthreadscheduling）机制。每个线程有自己的程序计数器。这使得伏特架构有了一些以前的架构所没有的新的线程束内同步与通信的模式，但导致：
<ul>
<li>增加了寄存器负担：单个线程的程序计数器一般需要使用两个寄存器。</li>
<li>独立线程调度机制使得假设了线程束同步（warpsynchronous）的代码变得不再安全：必须显式同步。</li>
</ul>
</li>
<li>线程束内的线程同步函数：都在一个线程束内时，可以将线程块同步函数<code>__syncthreads</code> 换成一个更加廉价的线程束同步函数<code>__syncwarp</code>。</li>
<li><a class="link" href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#warp-vote-functions"  target="_blank" rel="noopener"
    >其他基本函数</a>：
<ul>
<li>线程束表决函数（warpvotefunctions）</li>
<li>线程束匹配函数（warpmatchfunctions）</li>
<li>线程束洗牌函数（warp shuffle functions）</li>
<li>线程束矩阵函数（warp matrix functions）</li>
</ul>
</li>
</ul>
<h3 id="协作组cooperativegroups">协作组（cooperativegroups）
</h3><ul>
<li>类似线程块和线程束同步机制的推广，它提供了更为灵活的线程协作方式，包括线程块内部的同步与协作、线程块之间的（网格级的）同步与协作及设备之间的同步与协作。</li>
<li><a class="link" href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#introduction-cg"  target="_blank" rel="noopener"
    >https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#introduction-cg</a></li>
</ul>
<h2 id="cuda流cuda-stream">CUDA流（CUDA stream）
</h2><h3 id="cuda流介绍">CUDA流介绍
</h3><p>主要用cuda流解决<strong>核函数外部</strong>的并行：</p>
<ul>
<li>核函数计算与数据传输之间的并行。</li>
<li>主机计算与数据传输之间的并行。</li>
<li>不同的数据传输（回顾一下cudaMemcpy函数中的第4个参数）之间的并行。</li>
<li>核函数计算与主机计算之间的并行。</li>
<li>不同核函数之间的并行。</li>
</ul>
<p>任何CUDA操作都存在于某个CUDA流中，要么是默认流（default stream），也称为空流（null stream），要么是明确指定的非空流。</p>
<ul>
<li>在主机端产生与销毁。一个CUDA流由类型为cudaStream_t 的变量表示，<code>cudaStreamCreate</code>和<code>cudaStreamDestroy</code>创建和销毁。</li>
<li>为了实现不同CUDA流之间的并发，主机在向某个CUDA流中发布一系列命令之后必须马上获得程序的控制权，不用等待该CUDA流中的命令在设备中执行完毕。这样，就可以通过主机产生多个相互独立的CUDA流。</li>
<li>检查一个CUDA流中的所有操作是否都在设备中执行完毕：<code>cudaStreamSynchronize</code>同步、<code>cudaStreamQuery</code>查询</li>
</ul>
<h3 id="默认流default-stream-为空流null-stream">默认流（default stream）/ 为空流（null stream）
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">两种调用方式：
</span></span><span class="line"><span class="cl">my_kernel&lt;&lt;&lt;N_grid, N_block&gt;&gt;&gt;(函数参数);
</span></span><span class="line"><span class="cl">my_kernel&lt;&lt;&lt;N_grid, N_block, N_shared&gt;&gt;&gt;(函数参数);
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>核函数的启动是异步的（asynchronous），或者说是非阻塞的（non-blocking），所以会host会立即执行下一条语句。该命令如果是CUDA操作不会被device立即执行，因为这是默认流中的CUDA操作，必须等待前一个CUDA操作（即核函数的调用）执行完毕才会开始执行。</li>
<li>可以在核函数启动后放置host操作，利用前面CUDA操作完成时间。</li>
</ul>
<h3 id="非默认流非空流">非默认流/非空流
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">调用方式：
</span></span><span class="line"><span class="cl">my_kernel&lt;&lt;&lt;N_grid, N_block, N_shared, stream_id&gt;&gt;&gt;(函数参数);
</span></span><span class="line"><span class="cl">my_kernel&lt;&lt;&lt;N_grid,N_block, 0 ,stream_id&gt;&gt;&gt;(函数参数); // 不使用动态共享内存
</span></span><span class="line"><span class="cl"># stream_id是CUDA流的编号，N_shared是核函数中使用的动态共享内存的字节数。
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>用非默认CUDA流重叠核函数的执行与数据传递</strong></p>
<ul>
<li>要实现核函数执行与数据传输的并发（重叠），必须让这两个操作处于<strong>不同的非默认流</strong>，而且数据传输必须使用cudaMemcpy函数的异步版本，即<code>cudaMemcpyAsync</code>函数。异步传输由GPU中的DMA（directmemoryaccess）直接实现，不需要主机参与。</li>
<li>在使用异步的数据传输函数时，需要将主机内存定义为不可分页内存（non-pageable memory）或者固定内存（pinned memory），在程序运行期间，其物理地址将保持不变，由<code>cudaMallocHost</code>和<code>cudaFreeHost</code>申请和释放。</li>
</ul>
<h2 id="统一内存unifiedmemory编程">统一内存（unifiedmemory）编程
</h2><h3 id="介绍-1">介绍
</h3><ul>
<li>统一内存是一种逻辑上的概念，一种系统中的任何处理器（CPU或GPU）都可以访问，并能保证一致性的虚拟存储器。这种虚拟存储器是通过CPU和GPU各自内部集成的内存管理单元（memorymanagementunit）实现的。</li>
<li>使用统一内存对硬件有较高的要求：不低于开普勒架构等。</li>
<li>好处：不用手动内存传输管理；相比手动内存操作可能会有更好的性能；超量分配，类似虚拟内存策略。</li>
</ul>
<h3 id="基本使用">基本使用
</h3><ul>
<li>统一内存在设备中是当作全局内存使用的，而且必须在主机端定义或分配内存，而不能在设备端（核函数和<code>__device__</code>函数）定义或分配内存。</li>
<li>动态申请：<code>cudaMallocManaged</code></li>
<li>静态申请：<code> __device____managed__int ret[1000];</code></li>
<li>数据预取：<code>cudaMemPrefetchAsync</code></li>
</ul>
<h2 id="多gpu编程">多GPU编程
</h2><h2 id="cuda标准库">CUDA标准库
</h2><p>cuda所以接口及库详见官网：<a class="link" href="https://docs.nvidia.com/cuda/"  target="_blank" rel="noopener"
    >cuda docs</a>、<a class="link" href="https://developer.nvidia.com/cuda-zone"  target="_blank" rel="noopener"
    >cuda developer</a></p>
<h3 id="thrust">Thrust
</h3><p>类似于C++的标准模板库（standard template library）</p>
<ul>
<li><a class="link" href="https://github.com/NVIDIA/thrust"  target="_blank" rel="noopener"
    >thrust</a>、<a class="link" href="https://github.com/nvidia/cccl"  target="_blank" rel="noopener"
    >NCCL</a></li>
<li>数据结构：容器<code>thrust::host_vector&lt;typename&gt;</code>和<code>thrust::device_vector&lt;typename&gt;</code></li>
<li>算法：
<ul>
<li>
<ol>
<li>变换（transformation）。本书多次讨论的数组求和计算就是一种变换操作。</li>
</ol>
</li>
<li>
<ol start="2">
<li>规约（reduction）。这是本书重点讨论过的算法。</li>
</ol>
</li>
<li>
<ol start="3">
<li>前缀和（prefixsum）。下一节将详细讨论该算法。</li>
</ol>
</li>
<li>
<ol start="4">
<li>排序（sorting）与搜索（searching）。</li>
</ol>
</li>
<li>
<ol start="5">
<li>选择性复制、替换、移除、分区等重排（reordering）操作。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="cublasbasic-linear-algebra-subprograms">cuBLAS（basic linear algebra subprograms）
</h3><p>基本线性代数子程序，矩阵在内存中的存储是列主序（column-major order）的Fortran 风格，而不是像C语言中是行主序（row-majororder）的。</p>
<ul>
<li><a class="link" href="https://docs.nvidia.com/cuda/cublas/"  target="_blank" rel="noopener"
    >cublas</a>、<a class="link" href="https://www.netlib.org/blas/"  target="_blank" rel="noopener"
    >blas</a></li>
<li>cuBLAS 库包含3个API：
<ul>
<li>cuBLAS API：相关数据必须在设备。</li>
<li>cuBLASXTAPI：相关数据必须在主机。</li>
<li>cuBLASLt API：一个专门处理矩阵乘法的API。</li>
</ul>
</li>
</ul>
<h3 id="cufft">cuFFT
</h3><p>快速傅里叶变换（fast Fourier transforms）</p>
<ul>
<li><a class="link" href="https://docs.nvidia.com/cuda/cufft/index.html"  target="_blank" rel="noopener"
    >cufft</a></li>
</ul>
<h3 id="cusparse">cuSPARSE
</h3><p>稀疏（sparse）矩阵</p>
<ul>
<li><a class="link" href="https://docs.nvidia.com/cuda/cusparse/index.html"  target="_blank" rel="noopener"
    >cusparse</a></li>
<li>cusparse提供了一些稀疏矩阵、向量和稠密矩阵、向量的运算函数。</li>
</ul>
<h3 id="cusolver">cuSolver
</h3><p>稠密（dense）矩阵和稀疏（sparse）矩阵计算库</p>
<ul>
<li>cuSolver 专注于一些比较高级的线性代数方面的计算，如矩阵求逆和矩阵对角化，类似LAPACK库。基于cuBLAS和cuSPARSE两个更基础的库实现。</li>
<li><a class="link" href="https://docs.nvidia.com/cuda/cusolver/"  target="_blank" rel="noopener"
    >cusolver</a>、<a class="link" href="https://www.netlib.org/lapack/"  target="_blank" rel="noopener"
    >lapack</a></li>
<li>cuSolver 库由以下3个相互独立的子库组成：
<ul>
<li>cuSolverDN（DeNse, DN）：一个处理稠密矩阵线性代数计算的库。</li>
<li>cuSolverSP（SParse, SP）：一个处理稀疏矩阵的线性代数计算的库。</li>
<li>cuSolverRF（ReFactorization, RF）：一个特殊的处理稀疏矩阵分解的库。</li>
</ul>
</li>
<li>cuSolver 库函数倾向于使用异步执行。为了保证一个cuSolver函数的工作已经完成，可以使用<code>cudaDeviceSynchronize() </code>函数进行同步。</li>
</ul>
<h3 id="curand">cuRAND
</h3><p>与随机数生成有关的库,包含伪随机数（pseudorandom numbers）和准随机数（quasirandom numbers）。</p>
<ul>
<li><a class="link" href="https://docs.nvidia.com/cuda/curand/index.html"  target="_blank" rel="noopener"
    >curand</a></li>
<li>cuRand是后向兼容（backward compatible）的，注意cuRAND 和 the CUDA runtime的版本对应</li>
<li>提供了两种API：主机API和设备API。</li>
</ul>
<h3 id="cudnn">cuDNN
</h3><p>深度神经网络（deep neural networks）</p>
<ul>
<li>是一个用于深度神经网络的 GPU 加速基元库。cuDNN 为标准例程（如前向和后向卷积、注意力、matmul、池化和规范化）提供高度优化的实现。</li>
<li><a class="link" href="https://docs.nvidia.com/cudnn/index.html"  target="_blank" rel="noopener"
    >cudnn docs</a>、<a class="link" href="https://developer.nvidia.com/cudnn"  target="_blank" rel="noopener"
    >cudnn developer</a></li>
</ul>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 Mar 05, 2025 20:45 &#43;0800
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/onnx_quantization/">
        
        

        <div class="article-details">
            <h2 class="article-title">【ONNX量化】 ONNX量化推理介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/quantization/">
        
        

        <div class="article-details">
            <h2 class="article-title">【量化】 神经网络量化介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/arm-neon/">
        
        

        <div class="article-details">
            <h2 class="article-title">【SIMD】 ARM SIMD指令集NEON等介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/rvv/">
        
        

        <div class="article-details">
            <h2 class="article-title">【SIMD】 Risc-v SIMD指令集RVV介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/mpi/">
        
        

        <div class="article-details">
            <h2 class="article-title">【HPC】 MPI介绍</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="loveleaves/loveleaves.github.io"
    data-repo-id="R_kgDOHiRxVA"
    data-category="General"
    data-category-id="DIC_kwDOHiRxVM4Cmvtx"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading=""
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 Andrew Stark
    </section>
    
    <section class="powerby">
        
            loveleaves <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


<div id="aplayer"></div>
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script>
const staticDir = "https://loveleaves.github.io/";
const musicDir = staticDir + '/music/';
const songs = [
    'Dream_It_Possible-Delacey',
    'Love_Story-Taylor_Swift',
    'Never_Gonna_Give_You_Up-Rick_Astley',
    'Natural-Imagine_Dragons',
    'Rolling_In_the_Deep-Adele',
    'Apologize-OneRepublic',
    'Salt-Ava_Max',
    'Try-P!nk',
    'That_Girl-Olly_Murs',
    'Hymn_for_the_Weekend-Coldplay',
    'Hall_of_Fame-The_Script',
    'My_Stupid_Heart-Walk_Off_the_Earth&Luminati_Suns',
    'My_Songs_Know_What_You_Did_In_the_Dark-Taylor_Swift&Fall_Out_Boy',
    'See_You_Again-Wiz_Khalifa&Charlie_Puth',
    'Uptown_Funk-Mark_Ronson&Bruno_Mars',
    'Right_Now-Akon',
    'Whistle-Flo_Rida',
    'Numb-Linkin_Park',
    'Immortals-Fall_Out_Boy',
    'DJ_Got_Us_Falling_In_Love-Krusher',
    'Faded-Alan_Walker',
    'Something_Just_Like_This-The_Chainsmokers&Coldplay',
    'The_Phoenix-Fall_Out_Boy',
    'Umbrella-Rihanna&Jay_Z',
    'Animals_(Big_Boi_Remix)-Maroon_5',
    'Monsters-Katie_Sky',
    'Turnin’-Young_Rising_Sons',
    'What_Are_Words-Chris_Medina',
    'Normal_No_More-Tysm',
    'Go_Solo-Tom_Rosenthal',
    'Peter_Pan_Was_Right-Anson_Seabra',
    'Free_Loop-Daniel_Powter',
    'Empty_Love-Lulleaux&Kid_Princess',
    '青空-Candy_Wind',
    'Take_Me_Hand-DAISHI_DANCE',
    'Proud_Of_You-冯曦妤',
    'Please_Don’t_Go-Joel_Adams',
    'Forgettable-Project_46&Olivia',
    'Creep-Gamper_And_Dadoni',
    'Ferrari-Bebe_Rexha',
    'Legends_Never_Die(Alan_Walker_Remix)-Alan_Walker&Against_The_Current',
    'Love_the_Way_You_Lie-Eminem&Rihanna',
    'Lone_Ranger-Rachel_Platten',
    'What_Makes_You_Beautiful-One_Direction',
    'Let_Me_Down_Slowly-Alec_Benjamin',
    'My_Love-Westlife',
    'Counting_Stars-OneRepublic',
    'STAY-The_Kid_LAROI&Justin_Bieber',
    'Shape_of_You-Ed_Sheeran',
    'Booty_Music-Deep_Side',
    'Because_Of_You-Kelly_Clarkson',
    'Far_Away_from_Home-Groove_Coverage',
    'Move_Your_Body(Single_Mix)-Sia',
    'The_Nights(Original_Mix)-Avicii',
    'We_Dont_Talk_Anymore-Charlie_Puth&Selena_Gomez',
    'Moves_Like_Jagger(Radio_Edit)-Maroon_5',
    'You_Raise_Me_Up-Westlife',
    'Call_Me_Maybe(10_Kings_vs_Ollie_Green_Remix)-Carly_Rae_Jepsen',
    'Senorita-Shawn_Mendes&Camila_Cabello',
    'We_Will_Rock_You-Queen',
    'My_Heart_Will_Go_On-Celine_Dion&Webster'
];
let audios = [];
songs.forEach((item) => {
    const songInfo = item.split('-');
    audios.push({
        name: songInfo[0],
        artist: songInfo[1],
        url: musicDir + item + '/song.mp3',
        lrc: musicDir + item + '/song.lrc',
        cover: musicDir + 'cover.jpg', 
    })
});
const ap = new APlayer({
    container: document.getElementById('aplayer'),
    
    fixed: true,
    
    lrcType: 3,
    audio: audios
});
</script>





<script>
  const cdnPath = 'https://cdn.jsdelivr.net/gh/loveleaves/hugo-static-resource@main/live2d-widget-v3/';
  const myCdnPath = "https://cdn.jsdelivr.net/gh/loveleaves/hugo-static-resource@main/live2d/live2d-moc3/";
  
  const cssPath = "https://loveleaves.github.io/waifu/waifu.css";
  const tipsJsonPath = "https://loveleaves.github.io/waifu/waifu-tips.json";
  const tipsJsPath = "https://loveleaves.github.io/waifu/waifu-tips.js";
  const live2dJsPath = "https://loveleaves.github.io/waifu/live2d.min.js";

  const config = {
    
    path: {
      modelPath: myCdnPath,
      cssPath: cssPath,
      tipsJsonPath: tipsJsonPath,
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>

<style>
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url(https://loveleaves.github.io/icons/backTop.svg);
    }
</style>

<div id="particles-js"></div>

<script src=https://loveleaves.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://loveleaves.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>

<script>
    

    function initScrollTop() {
        let rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) {
            return;
        }
        
        let btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop
        rightSideBar.appendChild(btn)
        
        window.onscroll = function() {
            
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        };
    }

    

    function backToTop(){
        window.scrollTo({ top: 0, behavior: "smooth" })
    }

    initScrollTop();
</script>

<script>
    function initTocHide() {
        
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        
        window.addEventListener('scroll', function() {
            
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>

<script>
    

    window.onbeforeunload = () => {
        
        const playInfo = {
            index: ap.list.index,
            currentTime: ap.audio.currentTime,
            paused: ap.paused
        };
        localStorage.setItem("playInfo", JSON.stringify(playInfo));
    };

    

    window.onload = () => {
        
        const playInfo = JSON.parse(localStorage.getItem("playInfo"));
        if (!playInfo) {
            return;
        }
        
        ap.list.switch(playInfo.index);
        
        setTimeout(() => {
            
            ap.seek(playInfo.currentTime);
            
            if (!playInfo.paused) {
                ap.play()
            }
        }, 500);
    };
</script>

    </body>
</html>
