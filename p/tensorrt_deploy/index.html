<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="ä¸»è¦ä»‹ç»åˆ©ç”¨TensorRTéƒ¨ç½²æ¨¡å‹åŠæ¨ç†">
<title>ã€TensorRTã€‘ TensorRTæ¨¡å‹éƒ¨ç½²ä»‹ç»</title>

<link rel='canonical' href='https://loveleaves.github.io/p/tensorrt_deploy/'>

<link rel="stylesheet" href="/scss/style.min.6acf3e1a7a1dc2fa6c48d875b74f9fdb93ec0b14238fefbf571af44fb1221a41.css"><meta property='og:title' content="ã€TensorRTã€‘ TensorRTæ¨¡å‹éƒ¨ç½²ä»‹ç»">
<meta property='og:description' content="ä¸»è¦ä»‹ç»åˆ©ç”¨TensorRTéƒ¨ç½²æ¨¡å‹åŠæ¨ç†">
<meta property='og:url' content='https://loveleaves.github.io/p/tensorrt_deploy/'>
<meta property='og:site_name' content='å®‰å“²ç¿'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-03-02T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-03-05T20:45:08&#43;08:00'/>
<meta name="twitter:title" content="ã€TensorRTã€‘ TensorRTæ¨¡å‹éƒ¨ç½²ä»‹ç»">
<meta name="twitter:description" content="ä¸»è¦ä»‹ç»åˆ©ç”¨TensorRTéƒ¨ç½²æ¨¡å‹åŠæ¨ç†">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_b4d2f495c38e1067.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ˜</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">å®‰å“²ç¿</a></h1>
            <h2 class="site-description">ä¸–ä¸Šæ— éš¾äº‹ï¼Œåªæ€•æœ‰å¿ƒäºº</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/loveleaves'
                        target="_blank"
                        title="Github"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/loveleaves'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://loveleaves.github.io/en/" >English</option>
                                
                                    <option value="https://loveleaves.github.io/" selected>ç®€ä½“ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#references">References</a></li>
    <li><a href="#tensorrtæ¨ç†éƒ¨ç½²æ–¹æ¡ˆ">TensorRTæ¨ç†éƒ¨ç½²æ–¹æ¡ˆ</a>
      <ol>
        <li><a href="#cç¡¬ä»£ç æ–¹æ¡ˆ">C++ç¡¬ä»£ç æ–¹æ¡ˆ</a></li>
        <li><a href="#onnxæ–¹æ¡ˆ">ONNXæ–¹æ¡ˆ</a></li>
        <li><a href="#tensorrtåº“æ–‡ä»¶">TensorRTåº“æ–‡ä»¶</a></li>
      </ol>
    </li>
    <li><a href="#tensorrtéƒ¨ç½²æ¨ç†æ¨¡å‹æµç¨‹">TensorRTéƒ¨ç½²æ¨ç†æ¨¡å‹æµç¨‹</a>
      <ol>
        <li><a href="#æ¨¡å‹æ„å»º">æ¨¡å‹æ„å»º</a></li>
        <li><a href="#æ¨¡å‹æ¨ç†">æ¨¡å‹æ¨ç†</a>
          <ol>
            <li><a href="#åŠ¨æ€shape">åŠ¨æ€shape</a></li>
          </ol>
        </li>
        <li><a href="#onnxæ¨¡å‹æ“ä½œ">ONNXæ¨¡å‹æ“ä½œ</a></li>
        <li><a href="#onnx-parser">ONNX Parser</a>
          <ol>
            <li><a href="#å¯¼å‡ºtrtæ¨¡å‹">å¯¼å‡ºTRTæ¨¡å‹</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#plugin">Plugin</a></li>
    <li><a href="#é‡åŒ–">é‡åŒ–</a>
      <ol>
        <li><a href="#int8é‡åŒ–">int8é‡åŒ–</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tensorrt/" >
                TensorRT
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/tensorrt_deploy/">ã€TensorRTã€‘ TensorRTæ¨¡å‹éƒ¨ç½²ä»‹ç»</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ä¸»è¦ä»‹ç»åˆ©ç”¨TensorRTéƒ¨ç½²æ¨¡å‹åŠæ¨ç†
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 02, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 11 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="references">References
</h2><ul>
<li><a class="link" href="https://docs.nvidia.com/deeplearning/tensorrt/latest/getting-started/quick-start-guide.html"  target="_blank" rel="noopener"
    >tensorrt docs</a></li>
<li><a class="link" href="https://docs.nvidia.com/deeplearning/tensorrt/archives/"  target="_blank" rel="noopener"
    >tensorrt api</a></li>
<li><a class="link" href="https://docs.nvidia.com/deeplearning/tensorrt/latest/installing-tensorrt/installing.html"  target="_blank" rel="noopener"
    >install tensorrt</a></li>
<li><a class="link" href="https://github.com/NVIDIA/TensorRT/tree/main/samples"  target="_blank" rel="noopener"
    >TensorRT samples</a></li>
<li><a class="link" href="https://github.com/wang-xinyu/tensorrtx"  target="_blank" rel="noopener"
    >Implementation of popular deep learning networks with TensorRT</a></li>
</ul>
<h2 id="tensorrtæ¨ç†éƒ¨ç½²æ–¹æ¡ˆ">TensorRTæ¨ç†éƒ¨ç½²æ–¹æ¡ˆ
</h2><ul>
<li><a class="link" href="https://github.com/jinmin527/learning-cuda-trt"  target="_blank" rel="noopener"
    >learning-cuda-trt code</a></li>
<li><a class="link" href="https://github.com/loveleaves/TensorRT-Quantization"  target="_blank" rel="noopener"
    >tensorRT quantization</a></li>
</ul>
<h3 id="cç¡¬ä»£ç æ–¹æ¡ˆ">C++ç¡¬ä»£ç æ–¹æ¡ˆ
</h3><ul>
<li>ä»£è¡¨ï¼š<a class="link" href="https://github.com/wang-xinyu/tensorrtx"  target="_blank" rel="noopener"
    >tensorrtx</a></li>
<li>æµç¨‹ï¼šC++ç¡¬ä»£ç =ã€‹TRT API =ã€‹ TRT Builder =ã€‹ TRT Engine</li>
</ul>
<h3 id="onnxæ–¹æ¡ˆ">ONNXæ–¹æ¡ˆ
</h3><ul>
<li>æµç¨‹ï¼šONNX(libnvonnxparser.so) =ã€‹TRT API =ã€‹ TRT Builder =ã€‹ TRT Engine</li>
<li>ä¸€èˆ¬æ€è·¯ï¼š
<ol>
<li>å¯¼å‡ºæ¨¡å‹onnxï¼ŒæŸ¥çœ‹è¾“å…¥å’Œè¾“å‡ºã€‚</li>
<li>æŸ¥çœ‹ä»£ç ï¼Œæ‰¾åˆ°onnxçš„é¢„å¤„ç†ï¼Œåˆ†æé¢„å¤„ç†é€»è¾‘</li>
<li>åˆ©ç”¨ä¸Šè¿°ä¿¡æ¯å®ç°onnx pyæ¨ç†å®ç°</li>
<li>éªŒè¯æ­£å¸¸å¯å®ç°è½¬TRTæ¨¡å‹ç”¨C++å®ç°æ¨ç†</li>
</ol>
</li>
</ul>
<h3 id="tensorrtåº“æ–‡ä»¶">TensorRTåº“æ–‡ä»¶
</h3><ul>
<li>libnvinfer.soï¼šTensorRTæ ¸å¿ƒåº“</li>
<li>libnvinfer_plugin.soï¼šnvidiaå®˜æ–¹æä¾›çš„æ’ä»¶ï¼Œ<a class="link" href="https://github.com/NVIDIA/TensorRT/tree/main/plugin"  target="_blank" rel="noopener"
    >github</a></li>
<li>libprotobuf.soï¼šprotobufåº“</li>
<li>libnvonnxparser.soï¼šONNXè§£æ</li>
</ul>
<h2 id="tensorrtéƒ¨ç½²æ¨ç†æ¨¡å‹æµç¨‹">TensorRTéƒ¨ç½²æ¨ç†æ¨¡å‹æµç¨‹
</h2><h3 id="æ¨¡å‹æ„å»º">æ¨¡å‹æ„å»º
</h3><ul>
<li>tensorrtçš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾ï¼š
<ul>
<li>é¦–å…ˆå®šä¹‰ç½‘ç»œ</li>
<li>ä¼˜åŒ–builderå‚æ•°</li>
<li>é€šè¿‡builderç”Ÿæˆengine,ç”¨äºæ¨¡å‹ä¿å­˜ã€æ¨ç†ç­‰</li>
<li>engineå¯ä»¥é€šè¿‡åºåˆ—åŒ–å’Œé€†åºåˆ—åŒ–è½¬åŒ–æ¨¡å‹æ•°æ®ç±»å‹ï¼ˆè½¬åŒ–ä¸ºäºŒè¿›åˆ¶byteæ–‡ä»¶ï¼ŒåŠ å¿«ä¼ è¾“é€Ÿç‡ï¼‰ï¼Œå†è¿›ä¸€æ­¥æ¨åŠ¨æ¨¡å‹ç”±è¾“å…¥å¼ é‡åˆ°è¾“å‡ºå¼ é‡çš„æ¨ç†ã€‚<img src="/imgs/tensorRT/1.jpg"
	
	
	
	loading="lazy"
	
		alt="avatar"
	
	
></li>
</ul>
</li>
<li>code structure
<ol>
<li>å®šä¹‰ builder, config å’Œnetworkï¼Œå…¶ä¸­builderè¡¨ç¤ºæ‰€åˆ›å»ºçš„æ„å»ºå™¨ï¼Œconfigè¡¨ç¤ºåˆ›å»ºçš„æ„å»ºé…ç½®ï¼ˆæŒ‡å®šTensorRTåº”è¯¥å¦‚ä½•ä¼˜åŒ–æ¨¡å‹ï¼‰ï¼Œnetworkä¸ºåˆ›å»ºçš„ç½‘ç»œå®šä¹‰ã€‚</li>
<li>è¾“å…¥ï¼Œæ¨¡å‹ç»“æ„å’Œè¾“å‡ºçš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰
<img src="/imgs/tensorRT/2.jpg"
	
	
	
	loading="lazy"
	
		alt="avatar"
	
	
></li>
<li>ç”Ÿæˆengineæ¨¡å‹æ–‡ä»¶</li>
<li>åºåˆ—åŒ–æ¨¡å‹æ–‡ä»¶å¹¶å­˜å‚¨</li>
</ol>
</li>
</ul>
<h3 id="æ¨¡å‹æ¨ç†">æ¨¡å‹æ¨ç†
</h3><p>æ‰§è¡Œæ¨ç†çš„æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>å‡†å¤‡æ¨¡å‹å¹¶åŠ è½½</p>
</li>
<li>
<p>åˆ›å»ºruntimeï¼š<code>createInferRuntime(logger)</code></p>
</li>
<li>
<p>ä½¿ç”¨è¿è¡Œæ—¶æ—¶ï¼Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>ååºåˆ—åŒ–åˆ›å»ºengine, å¾—ä¸ºengineæä¾›æ•°æ®ï¼š<code>runtime-&gt;deserializeCudaEngine(modelData, modelSize)</code>,å…¶ä¸­<code>modelData</code>åŒ…å«çš„æ˜¯inputå’Œoutputçš„åå­—ï¼Œå½¢çŠ¶ï¼Œå¤§å°å’Œæ•°æ®ç±»å‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ModelData</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">INPUT_NAME</span> <span class="o">=</span> <span class="s">&#34;data&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">INPUT_SHAPE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span> <span class="c1">// [B, C, H, W]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">OUTPUT_NAME</span> <span class="o">=</span> <span class="s">&#34;prob&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">OUTPUT_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">DTYPE</span> <span class="o">=</span> <span class="n">trt</span><span class="p">.</span><span class="n">float32</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ä»engineåˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡:<code>engine-&gt;createExecutionContext()</code></p>
</li>
</ol>
</li>
<li>
<p>åˆ›å»ºCUDAæµ<code>cudaStreamCreate(&amp;stream)</code>ï¼š</p>
<ol>
<li>CUDAç¼–ç¨‹æµæ˜¯ç»„ç»‡å¼‚æ­¥å·¥ä½œçš„ä¸€ç§æ–¹å¼ï¼Œåˆ›å»ºæµæ¥ç¡®å®šbatchæ¨ç†çš„ç‹¬ç«‹</li>
<li>ä¸ºæ¯ä¸ªç‹¬ç«‹batchä½¿ç”¨IExecutionContext(3.2ä¸­å·²ç»åˆ›å»ºäº†)ï¼Œå¹¶ä¸ºæ¯ä¸ªç‹¬ç«‹æ‰¹æ¬¡ä½¿ç”¨cudaStreamCreateåˆ›å»ºCUDAæµã€‚</li>
</ol>
</li>
<li>
<p>æ•°æ®å‡†å¤‡ï¼š</p>
<ol>
<li>åœ¨hostä¸Šå£°æ˜<code>input</code>æ•°æ®å’Œ<code>output</code>æ•°ç»„å¤§å°ï¼Œæ¬è¿åˆ°gpuä¸Š</li>
<li>è¦æ‰§è¡Œinferenceï¼Œå¿…é¡»ç”¨ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„æŒ‡å®š<code>input</code>å’Œ<code>output</code>åœ¨gpuä¸­çš„æŒ‡é’ˆã€‚</li>
<li>æ¨ç†å¹¶å°†<code>output</code>æ¬è¿å›CPU</li>
</ol>
</li>
<li>
<p>å¯åŠ¨æ‰€æœ‰å·¥ä½œåï¼Œä¸æ‰€æœ‰æµåŒæ­¥ä»¥ç­‰å¾…ç»“æœ:<code>cudaStreamSynchronize</code></p>
</li>
<li>
<p>æŒ‰ç…§ä¸åˆ›å»ºç›¸åçš„é¡ºåºé‡Šæ”¾å†…å­˜</p>
</li>
</ol>
<p><strong>é‡è¦æ¥å£ä½¿ç”¨è¯´æ˜</strong>ï¼š</p>
<ul>
<li>TR10ä¸­çš„èŠ‚ç‚¹ç´¢å¼•å˜æ›´ä¸ºå­—ç¬¦ä¸²ï¼Œä¹‹å‰æ˜¯æ•°å€¼</li>
<li>å¿…é¡»ä½¿ç”¨createNetworkV2,å¹¶æŒ‡å®šä¸º1ï¼ˆè¡¨ç¤ºæ˜¾æ€§batchï¼‰ã€‚createNetworkå·²ç»åºŸå¼ƒï¼Œéæ˜¾æ€§batchå®˜æ–¹ä¸æ¨èã€‚è¿™ä¸ªæ–¹å¼ç›´æ¥å½±å“æ¨ç†æ—¶enqueueè¿˜æ˜¯enqueueV2ï¼ˆTR10ä¸ºV3ï¼‰</li>
<li>builderã€configç­‰æŒ‡é’ˆï¼Œè®°å¾—é‡Šæ”¾ï¼Œå¦åˆ™ä¼šæœ‰å†…å­˜æ³„æ¼ï¼Œä½¿ç”¨ptr-&gt;destroy()ï¼ˆTR10ä½¿ç”¨deleteï¼‰é‡Šæ”¾</li>
<li>markOutputè¡¨ç¤ºæ˜¯è¯¥æ¨¡å‹çš„è¾“å‡ºèŠ‚ç‚¹ï¼Œmarkå‡ æ¬¡ï¼Œå°±æœ‰å‡ ä¸ªè¾“å‡ºï¼Œaddlnputå‡ æ¬¡å°±æœ‰å‡ ä¸ªè¾“å…¥ã€‚è¿™ä¸æ¨ç†æ—¶ç›¸å‘¼åº”</li>
<li>workspaceSizeæ˜¯å·¥ä½œç©ºé—´å¤§å°ï¼ŒæŸäº›layeréœ€è¦ä½¿ç”¨é¢å¤–å­˜å‚¨æ—¶ï¼Œä¸ä¼šè‡ªå·±åˆ†é…ç©ºé—´ï¼Œè€Œæ˜¯ä¸ºäº†å†…å­˜å¤ç”¨ï¼Œç›´æ¥æ‰¾tensorRTè¦workspaceç©ºé—´ã€‚</li>
<li>bindingsæ˜¯tensorRTå¯¹è¾“å…¥è¾“å‡ºå¼ é‡çš„æè¿°ï¼Œ<code>bindings = input-tensor + output-tensor</code>ã€‚æ¯”å¦‚inputæœ‰a, outputæœ‰b,c, d,é‚£ä¹ˆ<code>bindings = [a, b, c, d],bindings[0] = a, bindings[2] = c</code>ã€‚æ­¤æ—¶çœ‹åˆ°<code>engine- &gt;getBindingDimensions(0)</code>ä½ å¾—çŸ¥é“è·å–çš„æ˜¯ä»€ä¹ˆï¼ˆTRT10æ”¹æˆäº†IOTensorsï¼‰</li>
<li><code>enqueueV2</code>æ˜¯å¼‚æ­¥æ¨ç†ï¼ŒåŠ å…¥åˆ°streamé˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚è¾“å…¥çš„bindingsåˆ™æ˜¯tensorsçš„æŒ‡é’ˆï¼ˆæ³¨æ„æ˜¯device pointerï¼‰ã€‚å…¶shapeå¯¹åº”äºç¼–è¯‘æ—¶æŒ‡å®šçš„è¾“å…¥è¾“å‡ºçš„shape(è¿™é‡Œåªæ¼”ç¤ºå…¨éƒ¨shapeé™æ€)ï¼ˆTRT10ä½¿ç”¨<code>enqueueV3</code>ï¼‰</li>
</ul>
<h4 id="åŠ¨æ€shape">åŠ¨æ€shape
</h4><ol>
<li>
<p>æ„å»ºç½‘ç»œæ—¶ï¼š</p>
<ul>
<li>1.1. å¿…é¡»åœ¨æ¨¡å‹å®šä¹‰æ—¶ï¼Œè¾“å…¥ç»´åº¦ç»™å®šä¸º-1ï¼Œå¦åˆ™è¯¥ç»´åº¦ä¸ä¼šåŠ¨æ€ã€‚æ³¨æ„ä¸€ä¸‹ä¸¤ç‚¹ï¼š
<ul>
<li>1.1.1. è‹¥onnxæ–‡ä»¶ï¼Œåˆ™onnxæ–‡ä»¶æ‰“å¼€ååº”è¯¥çœ‹åˆ°ä¸ºåŠ¨æ€æˆ–è€…-1</li>
<li>1.1.2. å¦‚æœä½ çš„æ¨¡å‹ä¸­å­˜åœ¨reshapeç±»æ“ä½œï¼Œé‚£ä¹ˆreshapeçš„å‚æ•°å¿…é¡»éšåŠ¨æ€è¿›è¡Œè®¡ç®—ã€‚è€Œå¤§éƒ¨åˆ†æ—¶å€™è¿™éƒ½æ˜¯é—®é¢˜ã€‚é™¤éä½ æ˜¯å…¨å·ç§¯æ¨¡å‹ï¼Œå¦åˆ™å¤§éƒ¨åˆ†æ—¶å€™åªéœ€è¦ä¸ºbatch_sizeç»´åº¦è®¾ç½®ä¸ºåŠ¨æ€ï¼Œå…¶ä»–ç»´åº¦å°½é‡é¿å…è®¾ç½®åŠ¨æ€</li>
</ul>
</li>
<li>1.2. é…ç½®profile:
<ul>
<li>1.2.1. create: <code>builder-&gt;createOptimizationProfile()</code></li>
<li>1.2.2. set: <code>setDimensions()</code>è®¾ç½®<code>kMIN</code>, <code>kOPT</code>, <code>kMAX</code>çš„ä¸€ç³»åˆ—è¾“å…¥å°ºå¯¸èŒƒå›´</li>
<li>1.2.3. add:<code>config-&gt;addOptimizationProfile(profile);</code>æ·»åŠ profileåˆ°ç½‘ç»œé…ç½®ä¸­</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ¨ç†é˜¶æ®µæ—¶ï¼š</p>
<ul>
<li>2.1. æ‚¨éœ€è¦åœ¨é€‰æ‹©profileçš„ç´¢å¼•åè®¾ç½®<code>input</code>ç»´åº¦ï¼š<code>execution_context-&gt;setBindingDimensions(0, nvinfer1::Dims4(1, 1, 3, 3));</code> ï¼ˆTR10ä¸º<code>setInputShape</code>ï¼‰
<ul>
<li>2.1.1. å…³äºprofileç´¢å¼•:
<img src="/imgs/tensorRT/3.jpg"
	
	
	
	loading="lazy"
	
		alt="multiple-optimization-profiles"
	
	
></li>
<li>2.1.2. åœ¨è¿è¡Œæ—¶ï¼Œå‘engineè¯·æ±‚ç»‘å®šç»´åº¦ä¼šè¿”å›ç”¨äºæ„å»ºç½‘ç»œçš„ç›¸åŒç»´åº¦ã€‚è¿™æ„å‘³ç€ï¼Œå¾—åˆ°çš„è¿˜æ˜¯åŠ¨æ€çš„ç»´åº¦[-1, in_channel, -1, -1]ï¼š
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">engine</span><span class="p">.</span><span class="n">getBindingDimensions</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// return [-1, 1, -1, -1]
</span></span></span><span class="line"><span class="cl"><span class="c1">// execution_context-&gt;getTensorShape // TR10æ¥å£
</span></span></span></code></pre></td></tr></table>
</div>
</div>è·å–å½“å‰çš„å®é™…ç»´åº¦ï¼Œéœ€è¦æŸ¥è¯¢æ‰§è¡Œä¸Šä¸‹æ–‡ï¼š
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">context</span><span class="p">.</span><span class="n">getBindingDimensions</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// return [3, 1, 3, 3]
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ£€æŸ¥æ­£ç¡®æ€§</p>
<ul>
<li>æˆ‘ä»¬é€šå¸¸å¯ä»¥åˆ©ç”¨pytorchæ¥æ ¡éªŒæ˜¯å¦å‘ç”Ÿäº†é”™è¯¯</li>
</ul>
</li>
</ol>
<h3 id="onnxæ¨¡å‹æ“ä½œ">ONNXæ¨¡å‹æ“ä½œ
</h3><p><a class="link" href="https://github.com/loveleaves/onnx-quantization/tree/main/onnx-editor"  target="_blank" rel="noopener"
    >ä»£ç å®æˆ˜</a>ï¼š</p>
<ol>
<li><code>pytorch-gen-onnx.py</code>ï¼šæ˜¯ä¹‹å‰è®²è¿‡çš„ä»pytorchè½¬æ¢onnxæ ¼å¼çš„ä»£ç ã€‚</li>
<li>é€šè¿‡<code>onnx-ml.proto</code>å’Œ<code>make-onnx-pb.sh</code>äº†è§£onnxçš„ç»“æ„
<ul>
<li>2.1. onnxæ˜¯åŸºäºprotobufæ¥åšæ•°æ®å­˜å‚¨å’Œä¼ è¾“,*.protoåç¼€æ–‡ä»¶, å…¶å®šä¹‰æ˜¯protobufè¯­æ³•ï¼Œç±»ä¼¼jsonã€‚</li>
<li>2.2. å¯¹äºå˜é‡ç»“æ„ã€ç±»å‹ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§<code>onnx-ml.proto</code>é‡Œé¢çš„å®šä¹‰ã€‚è¿™ä¸ªæ–‡ä»¶æœ‰800å¤šè¡Œï¼Œæ”¾å¿ƒæˆ‘ä»¬åªè¦ææ¸…æ¥šé‡Œé¢çš„æ ¸å¿ƒéƒ¨åˆ†å°±è¡Œï¼š
<ul>
<li><code>ModelProto</code>:å½“åŠ è½½äº†ä¸€ä¸ªonnxåï¼Œä¼šè·å¾—ä¸€ä¸ª<code>ModelProto</code>ã€‚å®ƒåŒ…å«ä¸€ä¸ª<code>GraphProto</code>å’Œä¸€äº›ç‰ˆæœ¬ï¼Œç”Ÿäº§è€…çš„ä¿¡æ¯ã€‚</li>
<li><code>GraphProto</code>: åŒ…å«äº†å››ä¸ªrepeatedæ•°ç»„(å¯ä»¥ç”¨æ¥å­˜æ”¾Nä¸ªç›¸åŒç±»å‹çš„å†…å®¹ï¼Œkeyå€¼ä¸ºæ•°å­—åºåˆ—ç±»å‹.)ã€‚è¿™å››ä¸ªæ•°ç»„åˆ†åˆ«æ˜¯node(<code>NodeProto</code>ç±»å‹)ï¼Œinput(<code>ValueInfoProto</code>ç±»å‹)ï¼Œoutput(<code>ValueInfoProto</code>ç±»å‹)å’Œinitializer(<code>TensorProto</code>ç±»å‹)ï¼›</li>
<li><code>NodeProto</code>: å­˜nodeï¼Œæ”¾äº†æ¨¡å‹ä¸­æ‰€æœ‰çš„è®¡ç®—èŠ‚ç‚¹,è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š
<img src="/imgs/tensorRT/4.jpg"
	
	
	
	loading="lazy"
	
		alt="nodeproto"
	
	
>
<img src="/imgs/tensorRT/2.jpg"
	
	
	
	loading="lazy"
	
		alt="avatar"
	
	
></li>
<li><code>ValueInfoProto</code>: å­˜inputï¼Œæ”¾äº†æ¨¡å‹çš„è¾“å…¥èŠ‚ç‚¹ã€‚å­˜outputï¼Œæ”¾äº†æ¨¡å‹ä¸­æ‰€æœ‰çš„è¾“å‡ºèŠ‚ç‚¹ï¼›</li>
<li><code>TensorProto</code>: å­˜initializerï¼Œæ”¾äº†æ¨¡å‹çš„æ‰€æœ‰æƒé‡å‚æ•°</li>
<li><code>AttributeProto</code>:æ¯ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸­è¿˜åŒ…å«äº†ä¸€ä¸ª<code>AttributeProto</code>æ•°ç»„ï¼Œç”¨æ¥æè¿°è¯¥èŠ‚ç‚¹çš„å±æ€§ï¼Œæ¯”å¦‚ConvèŠ‚ç‚¹æˆ–è€…è¯´å·ç§¯å±‚çš„å±æ€§åŒ…å«groupï¼Œpadï¼Œstridesç­‰ç­‰ï¼›</li>
</ul>
</li>
<li>2.3. é€šè¿‡protocç¼–è¯‘<code>onnx-ml.proto</code>ï¼Œäº§ç”Ÿ<code>onnx-ml.pb.cc</code>æ–‡ä»¶
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">bash make-onnx-pb.sh
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>create-onnx.py
<ul>
<li>3.1. create-onnx.pyç›´æ¥ä»æ„å»ºonnxï¼Œä¸ç»è¿‡ä»»ä½•æ¡†æ¶çš„è½¬æ¢ã€‚é€šè¿‡import onnxå’Œonnx.helperæä¾›çš„make_nodeï¼Œmake_graphï¼Œmake_tensorç­‰ç­‰æ¥å£æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„å®Œæˆä¸€ä¸ªONNXæ¨¡å‹çš„æ„å»ºã€‚</li>
<li>3.2. éœ€è¦å®Œæˆå¯¹nodeï¼Œinitializerï¼Œinputï¼Œoutputï¼Œgraphï¼Œmodelçš„å¡«å……</li>
<li>3.3. è¯»æ‡‚creat-onnx.pyä»¥make_nodeä¸ºä¾‹ï¼š
<img src="/imgs/tensorRT/5.jpg"
	
	
	
	loading="lazy"
	
		alt="make-node"
	
	
></li>
</ul>
</li>
<li>edit-onnx.py
<ul>
<li>4.1. ç”±äºprotobufä»»ä½•æ”¯æŒçš„è¯­è¨€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[c/c++/python/java/c#ç­‰ç­‰]å®ç°å¯¹onnxæ–‡ä»¶çš„è¯»å†™æ“ä½œ</li>
<li>4.2. æŒæ¡onnxå’Œhelperå®ç°å¯¹onnxæ–‡ä»¶çš„å„ç§ç¼–è¾‘å’Œä¿®æ”¹
<ul>
<li>å¢ï¼šä¸€èˆ¬ä¼´éšå¢åŠ nodeå’Œtensor
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">graph</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xxx_tensor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xxx_node</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>åˆ ï¼š
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">xxx_node</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>æ”¹ï¼š
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">input_node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
</li>
<li>read-onnx.py
<ul>
<li>5.1 é€šè¿‡<code>graph</code>å¯ä»¥è®¿é—®å‚æ•°ï¼Œæ•°æ®æ˜¯ä»¥protobufçš„æ ¼å¼å­˜å‚¨çš„ï¼Œå› æ­¤å½“ä¸­çš„æ•°å€¼ä¼šä»¥bytesçš„ç±»å‹ä¿å­˜ã€‚éœ€è¦ç”¨<code>np.frombuffer</code>æ–¹æ³•è¿˜åŸæˆç±»å‹ä¸º<code>float32</code>çš„<code>ndarray</code>ã€‚æ³¨æ„è¿˜åŸå‡ºæ¥çš„<code>ndarray</code>æ˜¯åªè¯»çš„ã€‚</li>
</ul>
</li>
</ol>
<h3 id="onnx-parser">ONNX Parser
</h3><p>onnxè§£æå™¨æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œ</p>
<ol>
<li><code>libnvonnxparser.so</code>æˆ–è€…</li>
<li><a class="link" href="https://github.com/onnx/onnx-tensorrt"  target="_blank" rel="noopener"
    >onnx-tensorrt parser</a>(æºä»£ç )ã€‚</li>
<li>ä½¿ç”¨æºä»£ç çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„è¿›è¡Œè‡ªå®šä¹‰å°è£…ï¼Œç®€åŒ–æ’ä»¶å¼€å‘æˆ–è€…æ¨¡å‹ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œæ›´åŠ å…·æœ‰å®šåˆ¶åŒ–ï¼Œé‡åˆ°é—®é¢˜å¯ä»¥è°ƒè¯•</li>
</ol>
<p><code>onnx-tensorrt parser</code>ä»£ç ä½¿ç”¨ï¼š</p>
<ol>
<li>ä»€ä¹ˆæ˜¯onnx:
<ol>
<li>å…ˆçœ‹åå­—ï¼šOpen Neural Network Exchange(ONNX) æ˜¯ä¸€ä¸ªå¼€æ”¾çš„ç”Ÿæ€ç³»ç»Ÿï¼Œä½¿ä»£ç ä¸è¢«å±€é™åœ¨æ¡†æ¶å’Œå¹³å°ä¸­ã€‚</li>
<li>å…·ä½“ä¸€ç‚¹ï¼šonnxå¯ä»¥æŠŠä½ çš„ç¥ç»ç½‘ç»œæ¨¡å‹(PyTroch, TF, Caffe)ç»Ÿç»Ÿè½¬ä¸ºæ ‡å‡†çš„ONNXæ ¼å¼(ä¸€ç§protobufæ ¼å¼)ï¼Œç„¶åå°±å¯åœ¨å„ç§å¹³å°(äº‘å¹³å°, windows, linux)å’Œè®¾å¤‡(cpu, gpu, npu)ä¸Šè¿è¡Œ
<img src="/imgs/tensorRT/6.onnx.jpg"
	
	
	
	loading="lazy"
	
		alt="onnx"
	
	
></li>
</ol>
</li>
<li>å…ˆçœ‹æ–‡ä»¶<code>gen-onnx.py</code>ä»¥pytorchæ„å»ºçš„æ¨¡å‹ä¸ºä¾‹è®²ï¼špytorchæ¨¡å‹è½¬onnxæ ¼å¼
<ol>
<li>æ„å»ºä¸€ä¸ªpytorchç½‘ç»œï¼Œå¹¶å£°æ˜ä¸€ä¸ªmodelå¯¹è±¡</li>
<li>å¦‚æœè¿›è¡Œæ¨ç†ï¼Œå°†æ¨¡å‹è®¾ä¸ºæ¨ç†çŠ¶æ€ï¼šè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºåƒdropout, batchnormè¿™æ ·çš„ç®—å­åœ¨æ¨ç†å’Œè®­ç»ƒæ¨¡å¼ä¸‹çš„è¡Œä¸ºæ˜¯ä¸åŒçš„ã€‚</li>
<li>å¯¼å‡ºä¸ºonnxæ¨¡å‹ï¼š<code>torch.onnx.export()</code></li>
<li>è¿è¡Œpythonè„šæœ¬ï¼Œç”Ÿæˆonnxï¼Œåœ¨<code>main.cpp</code>ä¸­ä¼šå¯¹å…¶è¿›è¡Œè§£æ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">python</span> <span class="n">gen</span><span class="o">-</span><span class="n">onnx</span><span class="o">.</span><span class="n">py</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>è¿è¡Œåçš„å›¾ç¤ºï¼š
<img src="/imgs/tensorRT/7.onnx-proto.jpg"
	
	
	
	loading="lazy"
	
		alt="onnx-proto"
	
	
>
<ul>
<li>Protobufåˆ™é€šè¿‡onnx-ml.protoç¼–è¯‘å¾—åˆ°onnx-ml.pb.hå’Œonnx-ml.pb.ccæˆ–onnx_ml_pb2.py</li>
<li>ç„¶åç”¨onnx-ml.pb.ccå’Œä»£ç æ¥æ“ä½œonnxæ¨¡å‹æ–‡ä»¶ï¼Œå®ç°å¢åˆ æ”¹</li>
<li>onnx-ml.protoåˆ™æ˜¯æè¿°onnxæ–‡ä»¶å¦‚ä½•ç»„æˆçš„ï¼Œå…·æœ‰ä»€ä¹ˆç»“æ„ï¼Œä»–æ˜¯æ“ä½œonnxç»å¸¸å‚ç…§çš„ä¸œè¥¿</li>
</ul>
</li>
</ol>
</li>
<li>å†çœ‹æ–‡ä»¶<code>main.cpp</code>è®²è§£å¦‚ä½•è§£æonnxæ ¼å¼
<ol>
<li>ä½¿ç”¨onnxè§£æå™¨ï¼š<code>createParser</code>çš„apiåœ¨æ–‡ä»¶NvOnnxParser.hä¸­</li>
<li>åœ¨è¿™é‡Œä½¿ç”¨onnxçš„ç»“æœå¡«å……åˆ°networkä¸­ï¼Œè€Œæ‰‹åŠ¨æ„å»ºç½‘ç»œåˆ™æ˜¯å°†è¾“å…¥å’Œç®—å­å¡«å…¥networkä¸­ï¼ŒåŒºåˆ«å¦‚å›¾æ‰€ç¤ºï¼š
<img src="/imgs/tensorRT/8.onnx-major-difference.jpg"
	
	
	
	loading="lazy"
	
		alt="onnx-major-difference"
	
	
></li>
<li>å¯¼å‡ºåï¼Œå¯ä»¥ä½¿ç”¨netronè½¯ä»¶è¿›è¡Œæ‰“å¼€æŸ¥çœ‹:https://github.com/lutzroeder/Netron</li>
</ol>
</li>
<li>é™¤äº†æ„å»ºè¿‡ç¨‹çš„åŒºåˆ«ï¼Œmakefileä¸­ï¼Œåº“æ–‡ä»¶ä¹Ÿéœ€è¦åŠ ä¸Šnvonnxparserï¼š
<img src="/imgs/tensorRT/9.makefile-difference.jpg"
	
	
	
	loading="lazy"
	
		alt="makefile-difference"
	
	
></li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>severity_string å’Œ logä»…æ˜¯å·¥å…·å‡½æ•°ï¼Œæ— éœ€è¿‡åˆ†å…³æ³¨</li>
</ul>
<h4 id="å¯¼å‡ºtrtæ¨¡å‹">å¯¼å‡ºTRTæ¨¡å‹
</h4><p>ä¸ºäº†ä½¿ç”¨onnxå¯¼å‡ºç½‘ç»œæœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<ol>
<li>æˆ‘ä»¬ä½¿ç”¨è‡ªå¸¦çš„è§£æå™¨ï¼Œ<code>libnvonnxparser.so</code></li>
<li>ä»æºä»£ç ç¼–è¯‘ï¼š<a class="link" href="https://github.com/onnx/onnx-tensorrt"  target="_blank" rel="noopener"
    >onnx-tensorrt</a>ï¼Œä¸»è¦protobufæ–‡ä»¶ï¼š
<ul>
<li><a class="link" href="https://github.com/onnx/onnx/blob/main/onnx/onnx-ml.proto"  target="_blank" rel="noopener"
    >onnx-ml.proto æ¥æº</a></li>
<li><a class="link" href="https://github.com/onnx/onnx/blob/main/onnx/onnx-operators-ml.proto"  target="_blank" rel="noopener"
    >onnx-operators-ml.proto æ¥æº</a></li>
</ul>
</li>
<li>åˆ©ç”¨å®˜æ–¹å·¥å…·<a class="link" href="https://github.com/NVIDIA/TensorRT/tree/main/samples/trtexec"  target="_blank" rel="noopener"
    ><code>trtexec</code></a>ï¼Œ<a class="link" href="https://github.com/loveleaves/TensorRT-Quantization/tree/main/object_detection/YOLOv8/normal"  target="_blank" rel="noopener"
    >YOLOv8éƒ¨ç½²æ¨ç†æ¡ˆä¾‹</a>
Usage:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">/usr/src/tensorrt/bin/trtexec <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--onnx<span class="o">=</span>yolov8s.onnx <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--saveEngine<span class="o">=</span>yolov8s.engine <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--fp16
</span></span><span class="line"><span class="cl"><span class="c1"># or --int8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="plugin">Plugin
</h2><p>1.å¦‚ä½•åœ¨pytorché‡Œé¢å¯¼å‡ºä¸€ä¸ªæ’ä»¶
2.æ’ä»¶è§£ææ—¶å¦‚ä½•å¯¹åº”ï¼Œåœ¨onnx parserä¸­å¦‚ä½•å¤„ç†
3.æ’ä»¶çš„creatorå®ç°
4.æ’ä»¶çš„å…·ä½“å®ç°ï¼Œç»§æ‰¿è‡ªIPluginV2DynamicExt
5.æ’ä»¶çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</p>
<h2 id="é‡åŒ–">é‡åŒ–
</h2><h3 id="int8é‡åŒ–">int8é‡åŒ–
</h3><ol>
<li>å¯¹äºint8ï¼Œéœ€è¦é…ç½®setFlag nvinfer1::BuilderFlag::kINT8ï¼Œå¹¶ä¸”é…ç½®setInt8Calibrator</li>
<li>å¯¹äºInt8EntropyCalibratorï¼Œåˆ™éœ€è¦ç»§æ‰¿è‡ªIInt8EntropyCalibrator2</li>
<li>Int8EntropyCalibratorçš„ä½œç”¨ï¼Œæ˜¯è¯»å–å¹¶é¢„å¤„ç†å›¾åƒæ•°æ®ä½œä¸ºè¾“å…¥
<ul>
<li>æ ‡å®šçš„åŸç†ï¼Œæ˜¯é€šè¿‡è¾“å…¥æ ‡å®šå›¾åƒIï¼Œä½¿ç”¨å‚æ•°WInt8æ¨ç†å¾—åˆ°è¾“å‡ºç»“æœPInt8ï¼Œç„¶åä¸æ–­è°ƒæ•´WInt8ï¼Œä½¿å¾—è¾“å‡ºPInt8ä¸PFloat32è¶Šæ¥è¿‘è¶Šå¥½</li>
<li>å› æ­¤æ ‡å®šæ—¶é€šå¸¸éœ€è¦ä½¿ç”¨ä¸€äº›å›¾åƒï¼Œæ­£å¸¸å‘å¸ƒæ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨100å¼ å›¾å·¦å³å³å¯</li>
</ul>
</li>
<li>å¸¸ç”¨çš„Calibrator
<ul>
<li>Int8EntropyCalibrator2
ç†µæ ¡å‡†é€‰æ‹©å¼ é‡çš„æ¯”ä¾‹å› å­æ¥ä¼˜åŒ–é‡åŒ–å¼ é‡çš„ä¿¡æ¯è®ºå†…å®¹ï¼Œé€šå¸¸ä¼šæŠ‘åˆ¶åˆ†å¸ƒä¸­çš„å¼‚å¸¸å€¼ã€‚è¿™æ˜¯å½“å‰æ¨èçš„ç†µæ ¡å‡†å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹å‰ã€‚æ¨èç”¨äºåŸºäº CNN çš„ç½‘ç»œã€‚
<img src="/imgs/tensorRT/10.int8EntropyCalibrator2.jpg"
	
	
	
	loading="lazy"
	
		alt="int8EntropyCalibrator2"
	
	
></li>
<li>Iint8MinMaxCalibrator
è¯¥æ ¡å‡†å™¨ä½¿ç”¨æ¿€æ´»åˆ†å¸ƒçš„æ•´ä¸ªèŒƒå›´æ¥ç¡®å®šæ¯”ä¾‹å› å­ã€‚å®ƒä¼¼ä¹æ›´é€‚åˆNLPä»»åŠ¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¡å‡†å‘ç”Ÿåœ¨å›¾å±‚èåˆä¹‹å‰ã€‚æ¨èç”¨äºNVIDIA BERTç­‰ç½‘ç»œã€‚
<img src="/imgs/tensorRT/11.int8MinMaxCalibrator.jpg"
	
	
	
	loading="lazy"
	
		alt="int8MinMaxCalibrator"
	
	
></li>
</ul>
</li>
<li>è®¡ç®—æœºä¸­çš„floatè®¡ç®—é‡æ˜¯éå¸¸å¤§çš„ï¼Œè€Œæ”¹æˆint8åï¼Œè®¡ç®—é‡ç›¸æ¯”å¯ä»¥æå‡æ•°å€
<ul>
<li>å¯¹äºå®é™…æ“ä½œæ—¶ï¼Œinput[float32], w[int8], bias[float32], output[float32]</li>
<li>æ­¥éª¤å¦‚ä¸‹ï¼š
<ul>
<li>input[int8] = to_int8(input[float32])</li>
<li>y[int16] = input[int8] * w[int8]   # æ­¤å¤„ä¹˜æ³•ä¼šç”±è®¡ç®—æœºè½¬æ¢ä¸ºint16ï¼Œä¿è¯ç²¾åº¦</li>
<li>output[float32] = to_float32(y[int16]) + bias[float32]</li>
</ul>
</li>
<li>æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹çš„åªæ˜¯ä¸ºäº†å‡å°‘float32çš„ä¹˜æ³•æ•°é‡ä»¥å®ç°æé€Ÿ</li>
<li>å¯¹äºto_int8çš„è¿‡ç¨‹ï¼Œå¹¶ä¸æ˜¯ç›´æ¥çš„çº¿æ€§ç¼©æ”¾ï¼Œè€Œæ˜¯ç»è¿‡KLæ•£åº¦è®¡ç®—æœ€åˆé€‚çš„æˆªæ–­ç‚¹ï¼ˆæœ€å¤§ã€æœ€å°å€¼ï¼‰ï¼Œè¿›è€Œè¿›è¡Œç¼©æ”¾ï¼Œä½¿å¾—æƒé‡çš„åˆ†å¸ƒå°½å¯èƒ½å°çš„è¢«æ”¹å˜
<ul>
<li>å¯ä»¥å‚ç…§è¿™ä¸ªåœ°å€ï¼šhttps://on-demand.gputechconf.com/gtc/2017/presentation/s7310-8-bit-inference-with-tensorrt.pdf</li>
</ul>
</li>
</ul>
</li>
</ol>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº Mar 05, 2025 20:45 &#43;0800
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="loveleaves/loveleaves.github.io"
    data-repo-id="R_kgDOHiRxVA"
    data-category="General"
    data-category-id="DIC_kwDOHiRxVM4Cmvtx"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading=""
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 Andrew Stark
    </section>
    
    <section class="powerby">
        
            loveleaves <br/>
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


<div id="aplayer"></div>
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script>
const staticDir = "https://loveleaves.github.io/";
const musicDir = staticDir + '/music/';
const songs = [
    'Dream_It_Possible-Delacey',
    'Love_Story-Taylor_Swift',
    'Never_Gonna_Give_You_Up-Rick_Astley',
    'Natural-Imagine_Dragons',
    'Rolling_In_the_Deep-Adele',
    'Apologize-OneRepublic',
    'Salt-Ava_Max',
    'Try-P!nk',
    'That_Girl-Olly_Murs',
    'Hymn_for_the_Weekend-Coldplay',
    'Hall_of_Fame-The_Script',
    'My_Stupid_Heart-Walk_Off_the_Earth&Luminati_Suns',
    'My_Songs_Know_What_You_Did_In_the_Dark-Taylor_Swift&Fall_Out_Boy',
    'See_You_Again-Wiz_Khalifa&Charlie_Puth',
    'Uptown_Funk-Mark_Ronson&Bruno_Mars',
    'Right_Now-Akon',
    'Whistle-Flo_Rida',
    'Numb-Linkin_Park',
    'Immortals-Fall_Out_Boy',
    'DJ_Got_Us_Falling_In_Love-Krusher',
    'Faded-Alan_Walker',
    'Something_Just_Like_This-The_Chainsmokers&Coldplay',
    'The_Phoenix-Fall_Out_Boy',
    'Umbrella-Rihanna&Jay_Z',
    'Animals_(Big_Boi_Remix)-Maroon_5',
    'Monsters-Katie_Sky',
    'Turninâ€™-Young_Rising_Sons',
    'What_Are_Words-Chris_Medina',
    'Normal_No_More-Tysm',
    'Go_Solo-Tom_Rosenthal',
    'Peter_Pan_Was_Right-Anson_Seabra',
    'Free_Loop-Daniel_Powter',
    'Empty_Love-Lulleaux&Kid_Princess',
    'é’ç©º-Candy_Wind',
    'Take_Me_Hand-DAISHI_DANCE',
    'Proud_Of_You-å†¯æ›¦å¦¤',
    'Please_Donâ€™t_Go-Joel_Adams',
    'Forgettable-Project_46&Olivia',
    'Creep-Gamper_And_Dadoni',
    'Ferrari-Bebe_Rexha',
    'Legends_Never_Die(Alan_Walker_Remix)-Alan_Walker&Against_The_Current',
    'Love_the_Way_You_Lie-Eminem&Rihanna',
    'Lone_Ranger-Rachel_Platten',
    'What_Makes_You_Beautiful-One_Direction',
    'Let_Me_Down_Slowly-Alec_Benjamin',
    'My_Love-Westlife',
    'Counting_Stars-OneRepublic',
    'STAY-The_Kid_LAROI&Justin_Bieber',
    'Shape_of_You-Ed_Sheeran',
    'Booty_Music-Deep_Side',
    'Because_Of_You-Kelly_Clarkson',
    'Far_Away_from_Home-Groove_Coverage',
    'Move_Your_Body(Single_Mix)-Sia',
    'The_Nights(Original_Mix)-Avicii',
    'We_Dont_Talk_Anymore-Charlie_Puth&Selena_Gomez',
    'Moves_Like_Jagger(Radio_Edit)-Maroon_5',
    'You_Raise_Me_Up-Westlife',
    'Call_Me_Maybe(10_Kings_vs_Ollie_Green_Remix)-Carly_Rae_Jepsen',
    'Senorita-Shawn_Mendes&Camila_Cabello',
    'We_Will_Rock_You-Queen',
    'My_Heart_Will_Go_On-Celine_Dion&Webster'
];
let audios = [];
songs.forEach((item) => {
    const songInfo = item.split('-');
    audios.push({
        name: songInfo[0],
        artist: songInfo[1],
        url: musicDir + item + '/song.mp3',
        lrc: musicDir + item + '/song.lrc',
        cover: musicDir + 'cover.jpg', 
    })
});
const ap = new APlayer({
    container: document.getElementById('aplayer'),
    
    fixed: true,
    
    lrcType: 3,
    audio: audios
});
</script>





<script>
  const cdnPath = 'https://cdn.jsdelivr.net/gh/loveleaves/hugo-static-resource@main/live2d-widget-v3/';
  const myCdnPath = "https://cdn.jsdelivr.net/gh/loveleaves/hugo-static-resource@main/live2d/live2d-moc3/";
  
  const cssPath = "https://loveleaves.github.io/waifu/waifu.css";
  const tipsJsonPath = "https://loveleaves.github.io/waifu/waifu-tips.json";
  const tipsJsPath = "https://loveleaves.github.io/waifu/waifu-tips.js";
  const live2dJsPath = "https://loveleaves.github.io/waifu/live2d.min.js";

  const config = {
    
    path: {
      modelPath: myCdnPath,
      cssPath: cssPath,
      tipsJsonPath: tipsJsonPath,
      tipsJsPath: cdnPath + "/waifu-tips.js",
      live2dCorePath: cdnPath + "/Core/live2dcubismcore.js",
      live2dSdkPath: cdnPath + "/live2d-sdk.js"
    },
    
    tools: ["hitokoto", "asteroids", "express", "switch-model", "switch-texture", "quit"],
    
    drag: {
      enable: true,
      direction: ["x", "y"]
    },
    
    switchType: "order"
  }

  
  if (screen.width >= 768) {
    Promise.all([
      loadExternalResource(config.path.cssPath, "css"),
      loadExternalResource(config.path.live2dCorePath, "js"),
      loadExternalResource(config.path.live2dSdkPath, "js"),
      loadExternalResource(config.path.tipsJsPath, "js")
    ]).then(() => {
      initWidget({
        waifuPath: config.path.tipsJsonPath,
        cdnPath: config.path.modelPath,
        tools: config.tools,
        dragEnable: config.drag.enable,
        dragDirection: config.drag.direction,
        switchType: config.switchType
      });
    });
  }

  
  function loadExternalResource(url, type) {
    return new Promise((resolve, reject) => {
      let tag;
      if (type === "css") {
        tag = document.createElement("link");
        tag.rel = "stylesheet";
        tag.href = url;
      }
      else if (type === "js") {
        tag = document.createElement("script");
        tag.src = url;
      }
      if (tag) {
        tag.onload = () => resolve(url);
        tag.onerror = () => reject(url);
        document.head.appendChild(tag);
      }
    });
  }
</script>

<style>
    #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 30px;
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url(https://loveleaves.github.io/icons/backTop.svg);
    }
</style>

<div id="particles-js"></div>

<script src=https://loveleaves.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://loveleaves.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>

<script>
    

    function initScrollTop() {
        let rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) {
            return;
        }
        
        let btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop
        rightSideBar.appendChild(btn)
        
        window.onscroll = function() {
            
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        };
    }

    

    function backToTop(){
        window.scrollTo({ top: 0, behavior: "smooth" })
    }

    initScrollTop();
</script>

<script>
    function initTocHide() {
        
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        
        window.addEventListener('scroll', function() {
            
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>

<script>
    

    window.onbeforeunload = () => {
        
        const playInfo = {
            index: ap.list.index,
            currentTime: ap.audio.currentTime,
            paused: ap.paused
        };
        localStorage.setItem("playInfo", JSON.stringify(playInfo));
    };

    

    window.onload = () => {
        
        const playInfo = JSON.parse(localStorage.getItem("playInfo"));
        if (!playInfo) {
            return;
        }
        
        ap.list.switch(playInfo.index);
        
        setTimeout(() => {
            
            ap.seek(playInfo.currentTime);
            
            if (!playInfo.paused) {
                ap.play()
            }
        }, 500);
    };
</script>

    </body>
</html>
